name: Sync SharePoint JSON to repo

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes

permissions:
  id-token: write
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Download JSON from SharePoint (Microsoft Graph)
        shell: bash
        env:
          SP_HOST: ${{ vars.SP_HOST }}
          SP_SITE_PATH: ${{ vars.SP_SITE_PATH }}
          SP_DRIVE_NAME: ${{ vars.SP_DRIVE_NAME }}
          SP_FILE_PATH: ${{ vars.SP_FILE_PATH }}
          TARGET_JSON_PATH: ${{ vars.TARGET_JSON_PATH }}
        run: |
          set -euo pipefail

          echo "Getting Graph access token..."
          TOKEN="$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)"

          echo "Resolving site ID..."
          SITE_JSON="$(curl -sS -H "Authorization: Bearer $TOKEN" \
            "https://graph.microsoft.com/v1.0/sites/${SP_HOST}:${SP_SITE_PATH}?\$select=id")"

          SITE_ID="$(echo "$SITE_JSON" | python -c "import sys,json; print(json.load(sys.stdin)['id'])")"
          echo "Site ID: $SITE_ID"

          echo "Listing drives on the site..."
          DRIVES_JSON="$(curl -sS -H "Authorization: Bearer $TOKEN" \
            "https://graph.microsoft.com/v1.0/sites/$SITE_ID/drives?\$select=id,name")"

          echo "$DRIVES_JSON" | python - <<'PY'
import sys, json
data = json.load(sys.stdin)
for d in data.get("value", []):
    print(f"- {d.get('name')} | {d.get('id')}")
PY

          echo "Selecting drive by name: $SP_DRIVE_NAME"
          DRIVE_ID="$(echo "$DRIVES_JSON" | python - <<'PY'
import os, sys, json
want = os.environ["SP_DRIVE_NAME"].strip().lower()
data = json.load(sys.stdin)
for d in data.get("value", []):
