name: Sync SharePoint JSON to repo

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # hourly

permissions:
  id-token: write
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Download JSON from SharePoint (Microsoft Graph)
        shell: bash
        env:
          SP_HOST: ${{ vars.SP_HOST }}
          SP_SITE_PATH: ${{ vars.SP_SITE_PATH }}          # use "/" for root site
          SP_DRIVE_NAME: ${{ vars.SP_DRIVE_NAME }}        # e.g. "Documents"
          SP_FILE_PATH: ${{ vars.SP_FILE_PATH }}          # e.g. "BandAvailability/availability.json"
          TARGET_JSON_PATH: ${{ vars.TARGET_JSON_PATH }}  # e.g. "data/availability.json"
        run: |
          set -euo pipefail

          TOKEN="$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)"

          SITE_ID="$(curl -fsSL -H "Authorization: Bearer $TOKEN" \
            "https://graph.microsoft.com/v1.0/sites/${SP_HOST}:${SP_SITE_PATH}?\$select=id" \
            | python -c "import sys,json; print(json.load(sys.stdin)['id'])")"

          DRIVE_ID="$(curl -fsSL -H "Authorization: Bearer $TOKEN" \
            "https://graph.microsoft.com/v1.0/sites/$SITE_ID/drives?\$select=id,name" \
            | python -c "import sys,json,os; want=os.environ['SP_DRIVE_NAME'].strip().lower(); d=json.load(sys.stdin); hits=[x['id'] for x in d.get('value',[]) if (x.get('name') or '').strip().lower()==want]; \
                         (print(hits[0]) if hits else (_ for _ in ()).throw(SystemExit('Drive not found: ' + os.environ['SP_DRIVE_NAME'])))")"

          ENCODED_PATH="$(python -c "import os,urllib.parse; print(urllib.parse.quote(os.environ['SP_FILE_PATH'], safe='/'))")"

          mkdir -p "$(dirname "$TARGET_JSON_PATH")"

          curl -fsSL -H "Authorization: Bearer $TOKEN" \
            "https://graph.microsoft.com/v1.0/drives/$DRIVE_ID/root:/$ENCODED_PATH:/content" \
            -o "$TARGET_JSON_PATH"

          python -c "import json; json.load(open('$TARGET_JSON_PATH','r',encoding='utf-8'))"

      - name: Commit and push if changed
        shell: bash
        env:
          TARGET_JSON_PATH: ${{ vars.TARGET_JSON_PATH }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$TARGET_JSON_PATH"

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Sync availability JSON from SharePoint"
          git push
