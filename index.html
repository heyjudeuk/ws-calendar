<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weird Science Band Availability</title>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121925;
      --muted:#9fb0c3;
      --text:#e6eef7;
      --border:#243246;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;

      /* Colour-blind safe palette (blue / amber) */
      --good:#2b6cb0;
      --bad:#d97706;
      --good2: rgba(43,108,176,.22);
      --bad2: rgba(217,119,6,.28);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #132033 0%, var(--bg) 60%);
      color: var(--text);
    }

    header{
      padding:22px 16px 10px;
      max-width:1200px;
      margin:auto;
    }

    h1{ margin:0 0 10px; font-size:22px; }

    .sub{ color:var(--muted); font-size:14px; margin-bottom:14px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      background:rgba(18,25,37,.65);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
    }

    label{ font-size:13px; color:var(--muted); }

    select{
      background:#0e1522;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      min-width:220px;
    }

    .legend{
      display:flex;
      gap:10px;
      align-items:center;
      margin-left:auto;
      flex-wrap:wrap;
    }

    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--border);
      background:#0e1522;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }

    .dot{ width:10px; height:10px; border-radius:50%; }
    .dot.good{ background:var(--good); }
    .dot.bad{ background:var(--bad); }

    main{
      max-width:1200px;
      margin:auto;
      padding:10px 16px 28px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
      margin-top:14px;
    }

    @media (max-width:980px){ .grid{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:640px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:rgba(18,25,37,.75);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .monthHeader{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      font-size:14px;
    }

    .cal{ padding:10px; }

    .dow, .days{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      text-align:center;
    }

    .dow{
      color:var(--muted);
      font-size:11px;
      margin-bottom:8px;
    }

    .day{
      position:relative;
      min-height:42px;
      border-radius:10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:2px;
      font-size:13px;
    }

    .day strong{ font-weight:700; }

    .day.good{
      background:var(--good2);
      border:1px solid rgba(43,108,176,.4);
    }

    .day.bad{
      background:var(--bad2);
      border:1px solid rgba(217,119,6,.45);
      background-image:repeating-linear-gradient(
        45deg,
        rgba(0,0,0,.14),
        rgba(0,0,0,.14) 7px,
        transparent 7px,
        transparent 14px
      );
    }

    .day.empty{ background:transparent; }

    .mark{ font-size:12px; }

    .tooltip{
      position:absolute;
      bottom:110%;
      left:50%;
      transform:translateX(-50%);
      background:#07101c;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      box-shadow:var(--shadow);
      display:none;
      white-space:nowrap;
      text-align:left;
      z-index:10;
    }

    .day.bad:hover .tooltip{ display:block; }

    .tooltip div{
      display:flex;
      gap:6px;
      align-items:center;
    }

    .raw{
      margin-top:18px;
      background:rgba(18,25,37,.75);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    th, td{
      padding:10px 12px;
      border-bottom:1px solid rgba(36,50,70,.6);
      text-align:left;
    }

    th{ font-size:12px; color:var(--muted); }

    .chip{
      display:inline-block;
      margin:2px 6px 2px 0;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0e1522;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
<header>
  <h1 id="title">Weird Science Band Availability</h1>
  <p class="sub" id="subtitle">Loading…</p>

  <div class="toolbar">
    <div>
      <label>Show availability for</label><br/>
      <select id="mode"></select>
    </div>

    <div class="legend">
      <div class="pill"><span class="dot good"></span> Available ✔</div>
      <div class="pill"><span class="dot bad"></span> Unavailable ✖</div>
      <div class="pill" id="rulePill"></div>
    </div>
  </div>
</header>

<main>
  <div id="calGrid" class="grid"></div>

  <div class="raw">
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Unavailable dates</th>
        </tr>
      </thead>
      <tbody id="rawBody"></tbody>
    </table>
  </div>
</main>

<script>
(() => {
  // Google Sheets "Publish to web" CSV
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqqmwi0YjOcvp6PoyFfhEd-YbYt6MxR11lxWhK4g6Hzh3dwWqMcch0xCTDQ8dkZ7qIhxvWjgwKqKpq/pub?gid=0&single=true&output=csv";

  const DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  const elGrid = document.getElementById('calGrid');
  const elMode = document.getElementById('mode');
  const elRule = document.getElementById('rulePill');
  const elRaw = document.getElementById('rawBody');
  const elTitle = document.getElementById('title');
  const elSubtitle = document.getElementById('subtitle');

  const pad = n => String(n).padStart(2,'0');
  const iso = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;

  // Parse CSV robustly (handles quoted fields + commas)
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let cur = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i+1];

      if (inQuotes) {
        if (ch === '"' && next === '"') {
          cur += '"';
          i++;
        } else if (ch === '"') {
          inQuotes = false;
        } else {
          cur += ch;
        }
      } else {
        if (ch === '"') {
          inQuotes = true;
        } else if (ch === ',') {
          row.push(cur);
          cur = '';
        } else if (ch === '\n') {
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
        } else if (ch === '\r') {
          // ignore CR
        } else {
          cur += ch;
        }
      }
    }
    // last field
    if (cur.length || row.length) {
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  function normaliseHeader(h) {
    return String(h || '').trim().toLowerCase().replace(/[^a-z0-9]/g,'');
  }

  // Accepts:
  // - YYYY-MM-DD
  // - YYYY/MM/DD
  // - DD/MM/YYYY
  // Returns ISO YYYY-MM-DD or null
  function toISODate(s) {
    const v = String(s || '').trim();
    if (!v) return null;

    // YYYY-MM-DD or YYYY/MM/DD
    let m = v.match(/^(\d{4})[-/](\d{2})[-/](\d{2})$/);
    if (m) {
      const y = +m[1], mo = +m[2], d = +m[3];
      if (isValidYMD(y,mo,d)) return iso(y,mo,d);
      return null;
    }

    // DD/MM/YYYY
    m = v.match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/);
    if (m) {
      const d = +m[1], mo = +m[2], y = +m[3];
      if (isValidYMD(y,mo,d)) return iso(y,mo,d);
      return null;
    }

    return null;
  }

  function isValidYMD(y,m,d) {
    if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return false;
    if (y < 1900 || y > 2100) return false;
    if (m < 1 || m > 12) return false;
    if (d < 1 || d > 31) return false;
    const dt = new Date(y, m-1, d);
    return dt.getFullYear() === y && dt.getMonth() === (m-1) && dt.getDate() === d;
  }

  // Inclusive range expansion
  function expandDates(startISO, endISO) {
    const out = [];
    const [sy, sm, sd] = startISO.split('-').map(Number);
    const [ey, em, ed] = endISO.split('-').map(Number);
    let cur = new Date(sy, sm-1, sd);
    const end = new Date(ey, em-1, ed);

    // guard against inverted ranges
    if (cur > end) return out;

    while (cur <= end) {
      out.push(iso(cur.getFullYear(), cur.getMonth()+1, cur.getDate()));
      cur.setDate(cur.getDate() + 1);
    }
    return out;
  }

  let state = {
    members: [],          // { name, unavailable: [YYYY-MM-DD...] }
    byDate: new Map(),    // date -> [names...]
    year: 2026,
    mode: '__ALL__'
  };

  fetch(CSV_URL, { cache: 'no-store' })
    .then(r => {
      if (!r.ok) throw new Error(`Failed to fetch CSV: HTTP ${r.status}`);
      return r.text();
    })
    .then(text => {
      const rows = parseCSV(text).filter(r => r.some(c => String(c||'').trim() !== ''));
      if (!rows.length) throw new Error('CSV is empty.');

      const header = rows[0] || [];
      const h = header.map(normaliseHeader);

      // Find column indices by header name; fallback to first three columns.
      const idxMember = h.findIndex(x => ['member','name','person','bandmember'].includes(x));
      const idxStart  = h.findIndex(x => ['startdate','start','from','datestart'].includes(x));
      const idxEnd    = h.findIndex(x => ['enddate','end','to','dateend'].includes(x));

      const memberCol = idxMember >= 0 ? idxMember : 0;
      const startCol  = idxStart  >= 0 ? idxStart  : 1;
      const endCol    = idxEnd    >= 0 ? idxEnd    : 2;

      const memberMap = new Map(); // name -> Set(dates)
      const byDate = new Map();
      const years = new Set();

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const nameRaw = (row[memberCol] ?? '').toString().trim();
        if (!nameRaw) continue;

        const startISO = toISODate(row[startCol]);
        const endISO = toISODate(row[endCol]) || startISO;
        if (!startISO || !endISO) continue;

        const dates = expandDates(startISO, endISO);
        if (!dates.length) continue;

        const name = nameRaw.toLowerCase(); // keep your existing lowercase style
        if (!memberMap.has(name)) memberMap.set(name, new Set());

        for (const d of dates) {
          memberMap.get(name).add(d);
          years.add(+d.slice(0,4));

          if (!byDate.has(d)) byDate.set(d, []);
          byDate.get(d).push(name);
        }
      }

      // Build members array
      const members = [...memberMap.entries()]
        .map(([name, set]) => ({ name, unavailable: [...set].sort() }))
        .sort((a,b) => a.name.localeCompare(b.name));

      // Sort tooltip names on each date
      for (const [d, names] of byDate.entries()) {
        names.sort((a,b) => a.localeCompare(b));
        byDate.set(d, names);
      }

      state.members = members;
      state.byDate = byDate;
      state.year = years.size === 1 ? [...years][0] : (years.size ? Math.min(...years) : 2026);

      elTitle.textContent = `Weird Science Band Availability for ${state.year}`;
      elSubtitle.textContent = 'Data source: Google Sheets (CSV)';

      buildMode();
      renderRaw();
      render();
    })
    .catch(err => {
      elSubtitle.textContent = 'Failed to load data.';
      elTitle.textContent = 'Weird Science Band Availability';
      console.error(err);
      elRaw.innerHTML = `<tr><td colspan="2">Error: ${String(err && err.message ? err.message : err)}</td></tr>`;
    });

  function buildMode() {
    elMode.innerHTML = '<option value="__ALL__">Whole band</option>';
    state.members
      .map(m => m.name)
      .sort()
      .forEach(n => {
        const o = document.createElement('option');
        o.value = o.textContent = n;
        elMode.appendChild(o);
      });

    elMode.onchange = () => { state.mode = elMode.value; render(); };
  }

  function render() {
    elGrid.innerHTML = '';
    elRule.textContent = state.mode === '__ALL__'
      ? '✔ only if nobody is unavailable'
      : `✔ / ✖ for ${state.mode}`;

    for (let m = 1; m <= 12; m++) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div class="monthHeader">${MONTHS[m-1]} ${state.year}</div>`;

      const cal = document.createElement('div');
      cal.className = 'cal';

      const dow = document.createElement('div');
      dow.className = 'dow';
      DOW.forEach(d => dow.innerHTML += `<div>${d}</div>`);

      const days = document.createElement('div');
      days.className = 'days';

      const first = new Date(state.year, m-1, 1);
      const offset = (first.getDay() + 6) % 7;
      for (let i = 0; i < offset; i++) days.innerHTML += '<div class="day empty"></div>';

      const count = new Date(state.year, m, 0).getDate();
      for (let d = 1; d <= count; d++) {
        const date = iso(state.year, m, d);
        const names = state.byDate.get(date) || [];
        const bad = state.mode === '__ALL__' ? names.length > 0 : names.includes(state.mode);

        const cell = document.createElement('div');
        cell.className = `day ${bad ? 'bad' : 'good'}`;
        cell.innerHTML = `<strong>${d}</strong><div class="mark">${bad ? '✖' : '✔'}</div>`;

        // Tooltip only for unavailable squares:
        // show the (whole-band) list of unavailable members for that date.
        if (bad) {
          const tt = document.createElement('div');
          tt.className = 'tooltip';

          (state.byDate.get(date) || []).forEach(n => {
            const row = document.createElement('div');
            row.textContent = `✖ ${n}`;
            tt.appendChild(row);
          });

          cell.appendChild(tt);
        }

        days.appendChild(cell);
      }

      cal.appendChild(dow);
      cal.appendChild(days);
      card.appendChild(cal);
      elGrid.appendChild(card);
    }
  }

  function renderRaw() {
    elRaw.innerHTML = '';
    state.members.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.name}</td><td>${
        m.unavailable.map(d => `<span class="chip">${d}</span>`).join('')
      }</td>`;
      elRaw.appendChild(tr);
    });
  }
})();
</script>
</body>
</html>
